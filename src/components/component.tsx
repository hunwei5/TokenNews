/**
* This code was generated by v0 by Vercel.
* @see https://v0.dev/t/FkFrFRPQada
* Documentation: https://v0.dev/docs#integrating-generated-code-into-your-nextjs-app
*/
'use client';
/** Add fonts into your Next.js project:

import { Inter } from 'next/font/google'

inter({
  subsets: ['latin'],
  display: 'swap',
})

To read more about using these font, please visit the Next.js documentation:
- App Directory: https://nextjs.org/docs/app/building-your-application/optimizing/fonts
- Pages Directory: https://nextjs.org/docs/pages/building-your-application/optimizing/fonts
**/



import '@rainbow-me/rainbowkit/styles.css';
import { Button } from "@/components/ui/button"
import Link from "next/link"
import { Card, CardHeader, CardContent } from "@/components/ui/card"
import { useAccount } from 'wagmi'
import { useEffect, useState, useRef } from 'react'
import {
  ConnectButton
} from '@rainbow-me/rainbowkit';
import ChatboxSDK from 'groupfi-chatbox-sdk'
import 'groupfi-chatbox-sdk/dist/esm/assets/style.css'
import { scrapeData, ArticlePreview } from '../lib/scraper';
import { SVGProps } from 'react';


export function Component() {
  const account = useAccount()
  const [isChatboxReady, setIsChatboxReady] = useState(false)
  const [walletProvider, setWalletProvider] = useState<
    undefined | null | unknown
  >(undefined)
  const isGettingWalletProvider = useRef(false)
  useEffect(() => {
    console.log("useEffect triggered")
    console.log("Component rendered");

    const handleChatboxReady = () => {
      setIsChatboxReady(true)
      console.log("handleChatboxReady rendered");

      let recommendGroupIdList: string[] = []
      console.log("recommendGroupIdList rendered");

        if (process.env.NEXT_PUBLIC_GROUPID_LIST) {
          recommendGroupIdList = JSON.parse(process.env.NEXT_PUBLIC_GROUPID_LIST)
          } 
          console.log("params",recommendGroupIdList)

      ChatboxSDK.request({
        method: 'setGroups',
        params: {
          includes: recommendGroupIdList.map((groupId) => ({ groupId }))
        }
      })

    } 

    ChatboxSDK.events.on('chatbox-ready', handleChatboxReady)

    return () => {
      ChatboxSDK.events.off('chatbox-ready', handleChatboxReady)
    }
  }, [])

  // Try get wallet Provider from account connector
  useEffect(() => {
    const asyncTryGetWalletProvider = async () => {
      try {
        if (account.connector === undefined) {
          setWalletProvider(null)
        } else if (
          Object.hasOwnProperty.bind(account.connector)('getProvider')
        ) {
          isGettingWalletProvider.current = true
          const walletProvider = await account.connector?.getProvider()
          setWalletProvider(walletProvider)
          isGettingWalletProvider.current = false
        }
      } catch (error) {
        console.error('Failed to get wallet provider', error)
      }
    }
    asyncTryGetWalletProvider()
  }, [account.connector])

  // Call the loadChatbox api or the processWallet api based on the walletProvider.
  useEffect(() => {
    if (walletProvider === undefined) {
      return
    }

    const isWalletConnected = walletProvider !== null

    // execute loadChatbox api or processWallet api
    // If chatbox is not ready, execute the loadChatbox api.
    if (!isChatboxReady) {
      ChatboxSDK.loadChatbox({
        isWalletConnected,
        provider: walletProvider ?? undefined
      })
    } else {
      // If chatbox is ready, execute processWallet api
      ChatboxSDK.processWallet({
        isWalletConnected,
        provider: walletProvider ?? undefined
      })
    }
  }, [walletProvider, isChatboxReady])

  useEffect(() => {
    if (
      !isGettingWalletProvider.current &&
      walletProvider &&
      isChatboxReady &&
      account.address !== undefined
    ) {
      // specify the address for the chatbox to load.
      ChatboxSDK.processAccount({
        account: account.address
      })
    }
  }, [isChatboxReady, walletProvider, account.address])

  const [articles, setArticles] = useState<ArticlePreview[]>([]);
  const [currentToken, setCurrentToken] = useState<string>('degen');
  const [groupId111, setGroupId] = useState<string>('groupfiDEGENcrabe2b86567396c9fd104f9d81545494131217f2ff264309d10c8d9a0198abd2bfb');

  useEffect(() => {
    async function fetchArticles(token: string) {
      try {
        const data = await scrapeData(token);
        console.log('Fetched and processed articles:', JSON.stringify(data, null, 2));
        setArticles(data);
      } catch (error) {
        console.error("Error fetching articles:", error);
      }
    }

    fetchArticles(currentToken);
  }, [currentToken]);



  const handleTokenClick = (token: string, groupId: string) => {
    setCurrentToken(token);
    setGroupId(groupId);

  }

  useEffect(() => {
    // 动态设置 Group
    ChatboxSDK.request({
      method: 'setGroups',
      params: {
        includes: [{ groupId: groupId111 }]
      }
    });
  }, [groupId111]);
  useEffect(() => {
    if (typeof window !== "undefined") {
      // 这里可以安全地使用 localStorage
      localStorage.setItem('key', 'value');
    }
     if (ls) return JSON.parse(ls);
    else return [];
  }, []);

  return (
    // head
    <div className="flex h-screen w-full flex-col">
      <header className="bg-primary text-primary-foreground p-4 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <NewspaperIcon className="h-6 w-6" />
          <h1 className="text-xl font-bold">Token News</h1>
        </div>
        <div className="flex items-center gap-2">
        <Button className="flex items-center gap-2">
          <ConnectButton />
            </Button>
        </div>
      </header>

      <div className="flex-1 flex justify-center">
        <div className="bg-muted/20 border-r p-4 w-64 flex flex-col gap-4">
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-medium">Token List</h2>
          </div>
          <nav className="flex flex-col gap-2">
            <Link href="#" className="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-muted" prefetch={false} onClick={() => handleTokenClick('degen', 'groupfiDEGENcrabe2b86567396c9fd104f9d81545494131217f2ff264309d10c8d9a0198abd2bfb')}>
              <span>Degen</span>
            </Link>
            <Link href="#" className="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-muted" prefetch={false} onClick={() => handleTokenClick('pepe', 'groupfiPEPEcrab1dc67c5f01ced4af90bcd6180c9d99d123e916ba1d57275ae8402307d4dd2226')}>
              <span>Pepe</span>
            </Link>
            <Link href="#" className="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-muted" prefetch={false} onClick={() => handleTokenClick('meme', 'groupfiMEMEcrabe970675cca3c4cf389b850095a36898cf50738d562fe51cd196b56c5340585e8')}>
              <span>Meme</span>
            </Link>
            <Link href="#" className="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-muted" prefetch={false} onClick={() => handleTokenClick('wld', 'groupfiWLDcrab68487d9c7a5cb78821151564a155a99da41bca5daf2fcec882f2d7a6ece4e96f')}>
              <span>WLD</span>
            </Link>
          </nav>
        </div>
        <div className="flex-1 flex flex-col">
          <div className="bg-muted/20 border-b p-4 flex items-center justify-between">
            <h2 className="text-lg font-medium">Latest News</h2>
            <div className="flex items-center gap-2">
            </div>
          </div>
          <div className="flex-1 overflow-auto p-4 grid gap-4">
              <CardContent>
                <div className="flex-1 overflow-auto p-4 grid gap-4">
            {articles.map((article, index) => (
              <Card key={index} className="bg-background border rounded-lg overflow-hidden">
                <CardHeader className="flex items-center gap-4 p-4 border-b">
                  <div>
                    <h3 className="font-semibold">{article.title}</h3>
                    {/* <p className="text-sm text-muted-foreground">{new Date(item.publishedAt).toLocaleDateString()}</p> */}
                  </div>
                </CardHeader>
                <CardContent className="p-4">
                  <p>{article.blurb}</p>
                </CardContent>
              </Card>
            ))}
          </div>
              </CardContent>
          </div>
        </div>
        <div className="bg-muted/20 border-l p-4 w-64 flex flex-col gap-4">
          <div className="flex items-center justify-between">
          </div>
        </div>
      </div>
    </div>
  )
}




function NewspaperIcon(props: SVGProps<SVGSVGElement>) {
  return (
    <svg
      {...props}
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    >
      <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" />
      <path d="M18 14h-8" />
      <path d="M15 18h-5" />
      <path d="M10 6h8v4h-8V6Z" />
    </svg>
  )
}

